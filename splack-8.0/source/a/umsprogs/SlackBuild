#!/bin/sh
# Set initial variables:
CWD=`pwd`
if [ "$TMP" = "" ]; then
  TMP=/tmp
fi
PKG=$TMP/package-umsprogs

if [ ! -d $TMP ]; then
  mkdir -p $TMP # location to build the source
fi
if [ ! -d $PKG ]; then
  mkdir -p $PKG # place for the package to be built
fi

# Explode the package framework:
cd $PKG
explodepkg $CWD/_umsprogs.tar.gz

echo "+===================+"
echo "| umsdos-progs-1.13 |"
echo "+===================+"
#echo "************* Recommend not using shared libg++"
cd $TMP
tar xzvf $CWD/umsdos_progs-1.13.tgz
cd umsdos_progs
zcat $CWD/umsdos.ryan-sparc.diff.gz | patch -p1
mkdir -p $PKG/usr/doc/umsdos-progs-1.13
cp -a README $PKG/usr/doc/umsdos-progs-1.13
cp -a util/README $PKG/usr/doc/umsdos-progs-1.13/README.utils
cp -a util/TODO $PKG/usr/doc/umsdos-progs-1.13/TODO
chown root.root $PKG/usr/doc/umsdos-progs-1.13/*
chmod 644 $PKG/usr/doc/umsdos-progs-1.13/*
make
## Relink without libstdc++, which seems unnecessary: (this is now the default)
#cc -o umssync main.o umssync.o umssetup.o udosctl.o \
#   umsdosio.o mangle.o numconst.o printk.o
cd util
strip umssync testver udump
cat umssync > $PKG/sbin/umssync
cat umssync.8 | gzip -9c > $PKG/usr/man/man8/umssync.8.gz
cat testver > $PKG/usr/sbin/testver
cat udump > $PKG/usr/sbin/udump

# Build the package:
cd $PKG
tar czvf $TMP/umsprogs.tgz .

# Clean up the extra stuff:
if [ "$1" = "--cleanup" ]; then
  rm -rf $TMP/umsdos_progs
  rm -rf $PKG
fi
